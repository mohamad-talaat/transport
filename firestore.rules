rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // ðŸ”§ Helper Functions
    // ============================================
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function isDriver(driverId) {
      return isAuth() && request.auth.uid == driverId;
    }
    
    function canAcceptTrips(driverId) {
      let driverDoc = get(/databases/$(database)/documents/users/$(driverId));
      return driverDoc.data.additionalData.debtIqD < 15000;
    }
    
    function isAdmin() {
      return isAuth() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // ============================================
    // ðŸ‘¥ Users Collection
    // ============================================
    match /users/{userId} {
      allow read: if isAuth() || isAdmin();
      allow create: if isAuth() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸš— Drivers Collection (Deprecated - merged with users)
    // ============================================
    match /drivers/{driverId} {
      allow read: if isAuth() || isAdmin();
      allow create: if isAuth() && request.auth.uid == driverId;
      allow update: if isDriver(driverId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸš• Trips Collection
    // ============================================
    match /trips/{tripId} {
      allow read: if isAuth() && (
        resource.data.riderId == request.auth.uid ||
        resource.data.driverId == request.auth.uid
      ) || isAdmin();
      
      allow create: if isAuth() || isAdmin();
      
      allow update: if isAuth() && (
        resource.data.riderId == request.auth.uid ||
        (request.resource.data.status == 'accepted' &&
         resource.data.status == 'pending' &&
         canAcceptTrips(request.auth.uid)) ||
        (resource.data.driverId == request.auth.uid &&
         resource.data.status in ['accepted', 'driverArrived', 'inProgress'])
      ) || isAdmin();
      
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸ“‹ Trip Requests Collection
    // ============================================
    match /trip_requests/{requestId} {
      // âœ… Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ù…Ø­ØªØ§Ø¬ÙŠÙ† ÙŠÙ‚Ø±ÙˆØ§ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØ³Ø¬Ù„ÙˆØ§ Ø¯Ø®ÙˆÙ„
      allow read: if isAuth();
      
      allow create: if isAuth() || isAdmin();
      
      allow update: if (isAuth() && 
                       resource.data.driverId == request.auth.uid &&
                       resource.data.status == 'pending') || isAdmin();
      
      allow delete: if isAuth() || isAdmin();
    }
    
    // ============================================
    // ðŸ’¬ Trip Chats Collection
    // ============================================
    match /trip_chats/{chatId} {
      allow read: if isAuth() || isAdmin();
      allow create: if isAuth();
      allow update: if isAuth() || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸ”” Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      allow read: if (isAuth() && resource.data.userId == request.auth.uid) || isAdmin();
      allow create: if isAuth() || isAdmin();
      allow update: if (isAuth() && resource.data.userId == request.auth.uid) || isAdmin();
      allow delete: if (isAuth() && resource.data.userId == request.auth.uid) || isAdmin();
    }
    
    // ============================================
    // ðŸ’° Wallets Collection
    // ============================================
    match /wallets/{walletId} {
      allow read: if (isAuth() && walletId == request.auth.uid) || isAdmin();
      allow write: if (isAuth() && walletId == request.auth.uid) || isAdmin();
    }
    
    // ============================================
    // ðŸ’³ Transactions Collection
    // ============================================
    match /transactions/{transactionId} {
      allow read: if (isAuth() && (
        resource.data.userId == request.auth.uid ||
        resource.data.fromUserId == request.auth.uid ||
        resource.data.toUserId == request.auth.uid
      )) || isAdmin();
      
      allow create: if isAuth() || isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸ¢ Service Centers Collection
    // ============================================
    match /serviceCenters/{centerId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // âš™ï¸ App Settings Collection (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ - Ù‚Ø±Ø§Ø¡Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹)
    // ============================================
    match /app_settings/{document=**} {
      allow read: if true; // âœ… Ø£ÙŠ Ø­Ø¯ ÙŠÙ‚Ø¯Ø± ÙŠÙ‚Ø±Ø£ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      allow write: if isAdmin();
    }
    
    // ============================================
    // ðŸŽ« Discount Codes Collection
    // ============================================
    match /discountCodes/{codeId} {
      allow read: if isAuth() || isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // ðŸŽŸï¸ Vouchers Collection
    // ============================================
    match /vouchers/{voucherId} {
      allow read: if isAuth() || isAdmin();
      allow create: if isAuth();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // â­ Trip Ratings Collection
    // ============================================
    match /trip_ratings/{ratingId} {
      allow read: if isAuth() || isAdmin();
      allow create: if isAuth();
      allow update: if (isAuth() && resource.data.riderId == request.auth.uid) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // ðŸ‘‘ Admins Collection
    // ============================================
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if false;
    }
    
    // ============================================
    // ðŸ“Š Admin Actions Log
    // ============================================
    match /adminActions/{actionId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if false;
    }
    
    // ============================================
    // ðŸ§ª Test Collection
    // ============================================
    match /test/{docId} {
      allow read, write: if isAuth() || isAdmin();
    }
    
    // ============================================
    // ðŸš« Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø£ÙŠ collection Ø¢Ø®Ø±
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

// ============================================
// ðŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©
// ============================================
// âœ… app_settings Ù…ØªØ§Ø­Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
// âœ… trip_requests Ù…ØªØ§Ø­Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
// âœ… Ø§Ù„Ø£Ø¯Ù…Ù† Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Collections
// âœ… Transactions Ø¢Ù…Ù†Ø© - Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
// 
// Required Firestore Indexes:
// - trips: riderId (ASC), status (ASC)
// - trips: driverId (ASC), status (ASC)
// - trip_requests: tripId (ASC), status (ASC)
// - trip_requests: driverId (ASC), status (ASC)
// - trip_requests: expiresAt (ASC), status (ASC)  â† Ù…Ù‡Ù… Ù„Ù„Ù€ cleanup
// - notifications: userId (ASC), createdAt (DESC)
// - transactions: userId (ASC), createdAt (DESC)
// ============================================
