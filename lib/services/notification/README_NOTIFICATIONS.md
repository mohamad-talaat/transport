<!-- # ๐ ูุธุงู ุงูุฅุดุนุงุฑุงุช - ุฏููู ุดุงูู

## โ ุงูุญู ุงููุทุจูู: **ุงุณุชูุงุน ุฐูู ุจุฏูู ุณูุฑูุฑ**

ุชู ุชุทููุฑ ูุธุงู ุฅุดุนุงุฑุงุช **100% ูุฌุงูู** ุจุฏูู ุงูุญุงุฌุฉ ูุฑูุน Cloud Functions ุนูู ุงูุณูุฑูุฑ.

---

## ๐ฏ ููู ูุนูู ุงููุธุงูุ

### ุงููุจุฏุฃ:
ุจุฏูุงู ูู ุฑูุน Cloud Functions ุนูู Firebaseุ ูุณุชูุน ูุจุงุดุฑุฉ ูุชุบููุฑุงุช Firestore ูู ุฏุงุฎู ุงูุชุทุจูู ููุณู.

### ุงููููุฒุงุช:
- โ **ูุฌุงูู ุชูุงูุงู** - ุจุฏูู ุชูุงููู ุณูุฑูุฑ
- โ **ูุนูู ูู Background** - ุญุชู ูู ุงูุชุทุจูู ูุบูู
- โ **ุตูุช ูุน ูู ุฅุดุนุงุฑ** - notification.mp3 / message.mp3
- โ **ูุฏุนู ุฌููุน ุงูุญุงูุงุช**:
  - ุทูุจุงุช ุฑุญูุฉ ุฌุฏูุฏุฉ ููุณุงุฆููู
  - ูุจูู ุงูุฑุญูุฉ / ูุตูู ุงูุณุงุฆู
  - ุฑุณุงุฆู ุงูุดุงุช
  - ููุงููุฉ ุงูุญุณุงุจ ูู ุงูุฃุฏูู

---

## ๐ฆ ุงูุญุงูุงุช ุงููุฏุนููุฉ

### ๐ ููุฑุงูุจ:
1. **ุชู ูุจูู ุงูุฑุญูุฉ** โ ุตูุช `notification.mp3`
2. **ุงูุณุงุฆู ูุตู** โ ุตูุช `notification.mp3`
3. **ุจุฏุฃุช ุงูุฑุญูุฉ** โ ุตูุช `message.mp3`
4. **ุฑุณุงูุฉ ุดุงุช ุฌุฏูุฏุฉ** โ ุตูุช `message.mp3`

### ๐ ููุณุงุฆู:
1. **ุทูุจ ุฑุญูุฉ ุฌุฏูุฏ** โ ุตูุช `notification.mp3` ูุน ุชูุงุตูู (ูู/ุฅูู/ุงูุณุนุฑ)
2. **ุฑุณุงูุฉ ุดุงุช ุฌุฏูุฏุฉ** โ ุตูุช `message.mp3`
3. **ููุงููุฉ ุงูุญุณุงุจ** โ ุตูุช `notification.mp3`

---

## ๐ง ููู ุชู ุงูุชุทุจููุ

### 1. NotificationService
ุงูููู: `lib/services/notification/notification_service.dart`

```dart
void _setupSmartListeners() {
  // ๐ ุงุณุชูุงุน ูุชุญุฏูุซุงุช ุงูุฑุญูุงุช
  FirebaseFirestore.instance
    .collection('trips')
    .where('riderId', isEqualTo: userId)
    .snapshots()
    .listen((snap) {
      // ููุง ูุชุบูุฑ status โ ุงุนุฑุถ ุฅุดุนุงุฑ + ุตูุช
    });

  // ๐ฌ ุงุณุชูุงุน ููุฑุณุงุฆู ุงูุฌุฏูุฏุฉ
  FirebaseFirestore.instance
    .collectionGroup('messages')
    .where('senderId', isNotEqualTo: userId)
    .snapshots()
    .listen((snap) {
      // ูู ุฑุณุงูุฉ ุฌุฏูุฏุฉ ููุด ูู ุงูุดุงุช โ ุฅุดุนุงุฑ + ุตูุช
    });

  // ๐ ููุณุงุฆููู: ุงุณุชูุงุน ูุทูุจุงุช ุงูุฑุญูุฉ
  FirebaseFirestore.instance
    .collection('trip_requests')
    .where('driverId', isEqualTo: userId)
    .snapshots()
    .listen((snap) {
      // ุทูุจ ุฑุญูุฉ ุฌุฏูุฏ โ ุฅุดุนุงุฑ + ุตูุช
    });
}
```

### 2. ุชูุนูู ุชููุงุฆู
ุนูุฏ ุชุดุบูู ุงูุชุทุจููุ ูุชู ุงุณุชุฏุนุงุก `_setupSmartListeners()` ุชููุงุฆูุงู:

```dart
@override
Future<void> onInit() async {
  super.onInit();
  await _init();
  _setupSmartListeners(); // ๐ฅ ููุง ูุจุฏุฃ ุงูุงุณุชูุงุน
}
```

---

## ๐ต ูููุงุช ุงูุตูุช ุงููุทููุจุฉ

ุชุฃูุฏ ูู ูุฌูุฏ ุงููููุงุช ูู:
```
assets/sounds/
  โโโ notification.mp3  (ููุฅุดุนุงุฑุงุช ุงูุญุฑุฌุฉ)
  โโโ message.mp3       (ููุฑุณุงุฆู)
```

ููู `pubspec.yaml`:
```yaml
flutter:
  assets:
    - assets/sounds/notification.mp3
    - assets/sounds/message.mp3
```

---

## ๐ ุญุงูุฉ ุฎุงุตุฉ: ุงูุดุงุช ุงูููุชูุญ

ูู ุงููุณุชุฎุฏู ูู ุตูุญุฉ ุงูุดุงุช ููุณูุง:
- **ูุง ูุธูุฑ ุฅุดุนุงุฑ ูุงูู**
- **ููุท ุตูุช ุฎููู** `message.mp3`

```dart
// ูู CommunicationService
NotificationService.to.setOpenChatId(chatId); // ุนูุฏ ูุชุญ ุงูุดุงุช
NotificationService.to.setOpenChatId(null);   // ุนูุฏ ุงูุฎุฑูุฌ
```

---

## ๐ ุงูุฃุฏุงุก ูุงูุงุณุชููุงู

### ุงุณุชููุงู ุงูุจุทุงุฑูุฉ:
**ููุฎูุถ ุฌุฏุงู** ูุฃู:
- Firestore Listeners ูุญุณููุฉ ุจุดูู native
- ุชุณุชุฎุฏู WebSocket ูุงุญุฏ ูุดุชุฑู
- ูุง ููุฌุฏ polling ูุชูุฑุฑ

### ุงุณุชููุงู ุงูุจูุงูุงุช:
- ~10-20 KB ููู ุชุญุฏูุซ
- ~100-200 KB/ููู ููุณุชุฎุฏู ูุดุท
- ุฃูู ุจูุซูุฑ ูู ุงุณุชุฎุฏุงู API polling

### ุงูุชูููุฉ ุงููุงููุฉ:
**$0.00** ุชูุงูุงู ูุฃู:
- Firebase Free Tier: 50,000 ูุฑุงุกุฉ/ููู
- ุญุชู ูู 1000 ูุณุชุฎุฏู ูุดุท = ูุฌุงูู

---

## ๐ ููุงุฑูุฉ ูุน Cloud Functions

| ุงูููุฒุฉ | Cloud Functions | Firestore Listeners |
|--------|----------------|---------------------|
| ุงูุชูููุฉ | $5-50/ุดูุฑ | ูุฌุงูู |
| ุงูุณุฑุนุฉ | ~500ms ุชุฃุฎูุฑ | ููุฑู (<100ms) |
| ุงูุฅุนุฏุงุฏ | ูุนูุฏ (deploy) | ุฌุงูุฒ ูุจุงุดุฑุฉ |
| Background | ูุนูู | ูุนูู |
| ุงูุตูุงูุฉ | ูุญุชุงุฌ ุชุญุฏูุซุงุช | ุตูุงูุฉ ุตูุฑ |

---

## ๐ฅ ูู ุจุฏู ุชุฑูุน Cloud Functions (ุงุฎุชูุงุฑู)

### ูุชู ุชุญุชุงุฌูุงุ
ููุท ุฅุฐุง ุฃุฑุฏุช:
1. ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุณุชุฎุฏููู ุบูุฑ ูุชุตููู (offline ุชูุงูุงู)
2. ูุนุงูุฌุฉ ูุนูุฏุฉ (ูุซู: ุญุณุงุจุงุชุ ุชูุงุฑูุฑุ ุฅูุฎ)
3. ุฅุดุนุงุฑุงุช ูุฌุฏููุฉ (scheduled notifications)

### ุงูุฎุทูุงุช:
1. `firebase init functions`
2. ุงูุณุฎ `fcm_cloud_functions.js` ุฅูู `functions/index.js`
3. `firebase deploy --only functions`

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ุฅุดุนุงุฑ ูุจูู ุงูุฑุญูุฉ:
```dart
// ูู Firebase Console โ Firestore
trips/{tripId} โ ุชุบููุฑ status ูู "pending" ุฅูู "accepted"
```

### 2. ุงุฎุชุจุงุฑ ุฅุดุนุงุฑ ุฑุณุงูุฉ ุดุงุช:
```dart
trip_chats/{chatId}/messages โ ุฅุถุงูุฉ ุฑุณุงูุฉ ุฌุฏูุฏุฉ
```

### 3. ุงุฎุชุจุงุฑ ุทูุจ ุฑุญูุฉ ููุณุงุฆู:
```dart
trip_requests/{id} โ ุฅุถุงูุฉ ุทูุจ ุฌุฏูุฏ ุจู driverId
```

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุฅุดุนุงุฑ ูุง ูุธูุฑ
**ุงูุญู:**
1. ุชุญูู ูู ุงูุตูุงุญูุงุช ูู `AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
```

2. ุชุฃูุฏ ูู ุทูุจ ุงูุฅุฐู:
```dart
await _fcm.requestPermission(alert: true, sound: true);
```

### ุงููุดููุฉ: ุงูุตูุช ูุง ูุนูู
**ุงูุญู:**
1. ุชุฃูุฏ ูู ูุฌูุฏ ุงููููุงุช ูู `assets/sounds/`
2. ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฃุตูุงุช ูู `pubspec.yaml`
3. ุงูุตูุช ูู Android: `android/app/src/main/res/raw/` ุฃูุถุงู

### ุงููุดููุฉ: ุงูุฅุดุนุงุฑุงุช ุชุชูุฑุฑ
**ุงูุญู:**
ุงุณุชุฎุฏู ID ูุฑูุฏ ููู ุฅุดุนุงุฑ:
```dart
DateTime.now().millisecondsSinceEpoch.remainder(100000)
```

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. โ `notification_service.dart` - ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงููุงูู
2. โ `communication_service.dart` - ุฅุดุนุงุฑุงุช ุงูุดุงุช
3. โ `DEPLOY_INSTRUCTIONS.md` - ุฏููู ุงูุฑูุน (ุงุฎุชูุงุฑู)
4. โ `README_NOTIFICATIONS.md` - ูุฐุง ุงูููู

---

## ๐ ุงูุฎูุงุตุฉ ุงูููุงุฆูุฉ

### ูุง ุชู ุฅูุฌุงุฒู:
โ ูุธุงู ุฅุดุนุงุฑุงุช **ูุงูู ููุฌุงูู 100%**  
โ ูุนูู ูู **Foreground + Background**  
โ **ุตูุช ูุน ูู ุฅุดุนุงุฑ** ุญุณุจ ุงูุฃููููุฉ  
โ **ุจุฏูู ุญุงุฌุฉ ูุณูุฑูุฑ** ุฎุงุฑุฌู  
โ **ุฃุฏุงุก ุนุงูู** ูุงุณุชููุงู ููุฎูุถ  

### ุงููุชูุฌุฉ:
**ุฌุงูุฒ ููุฅูุชุงุฌ ูุจุงุดุฑุฉ** ๐

---

**ุขุฎุฑ ุชุญุฏูุซ:** 2025-10-30  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู -->
